name: Sync

on: [push]

jobs:
  sync:
    runs-on: ubuntu-18.04

    steps:
       - name: Checkout
         uses: actions/checkout@master
       
       - name: Cleanup
         uses: rokibhasansagar/slimhub_actions@main

       - name: Init
         run: |
          sudo apt update; sudo apt -y install gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libxml2 lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev python
          sudo chmod -R 777 ./
          ./git.sh ; sudo ./repo.sh ; sudo ./init.sh

       - name: Set Swap Space
         uses: pierotofy/set-swap-space@master
         with:
          swap-size-gb: 12

       - name: Install OpenJDK
         uses: actions/setup-java@v3
         with:
          distribution: 'zulu'
          java-version: '8'

       - name: Sync
         run: |
          sudo ~/.bin/repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j8

       - name: Build
         run: |
          export MAINTAINER=rahulkhatri137 ; export VENDOR=oppo ; export CODENAME=CPH1861 ; export VERSION=3.1.0 ; export TEST_BUILD=true
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          lunch omni_CPH1861-eng
          sudo mka pbrp

       - name: Upload
         run: |
          cd out/target/product ; curl -sL https://git.io/file-transfer | sh ; sudo chmod a+x transfer ; ./transfer wet *
